# I/O Definitions - Bit-Serial Bus System

This document defines all input/output ports for each module in the bit-serial bus system. All modules use the lowRISC naming convention: `_i` suffix for inputs, `_o` suffix for outputs.

## Global Parameters (bus_pkg.sv)

```systemverilog
parameter int unsigned ADDR_WIDTH = 14;     // 14-bit address (16KB space)
parameter int unsigned DATA_WIDTH = 8;      // 8-bit data
parameter int unsigned NUM_MASTERS = 2;     // 2 masters
parameter int unsigned NUM_SLAVES = 3;      // 3 slaves
parameter int unsigned FRAME_WIDTH = 27;    // Serial frame: 27 bits
parameter int unsigned SERIAL_CLK_DIV = 4;  // SCLK = CLK / 4
```

**Address Map**:
```systemverilog
SLAVE0_BASE = 0x0000, SLAVE0_SIZE = 0x1000  // 4KB (0x0000-0x0FFF)
SLAVE1_BASE = 0x1000, SLAVE1_SIZE = 0x1000  // 4KB (0x1000-0x1FFF)
SLAVE2_BASE = 0x2000, SLAVE2_SIZE = 0x0800  // 2KB (0x2000-0x27FF)
```

---

## 1. serializer

**Purpose**: Converts 27-bit parallel frame to serial bitstream

| Port Name  | Direction | Width | Description |
|------------|-----------|-------|-------------|
| `clk_i`    | Input     | 1     | System clock (50 MHz) |
| `rst_ni`   | Input     | 1     | Async active-low reset |
| `start_i`  | Input     | 1     | Pulse to begin serialization |
| `frame_i`  | Input     | 27    | Parallel frame (serial_frame_t) |
| `busy_o`   | Output    | 1     | HIGH during serialization |
| `done_o`   | Output    | 1     | Pulse when 27 bits transmitted |
| `sdata_o`  | Output    | 1     | Serial data output (MSB first) |
| `sclk_o`   | Output    | 1     | Serial clock output (12.5 MHz) |

**Notes**:
- `frame_i` sampled when `start_i` asserted and `busy_o` LOW
- `sclk_o` generated by internal 2-bit divider (CLK/4)
- `sdata_o` changes on falling edge of `sclk_o`, stable on rising edge
- `done_o` pulses for 1 system clock after bit 26 transmitted

---

## 2. deserializer

**Purpose**: Converts serial bitstream to 27-bit parallel frame

| Port Name        | Direction | Width | Description |
|------------------|-----------|-------|-------------|
| `clk_i`          | Input     | 1     | System clock (50 MHz) |
| `rst_ni`         | Input     | 1     | Async active-low reset |
| `sdata_i`        | Input     | 1     | Serial data input |
| `sclk_i`         | Input     | 1     | Serial clock input (12.5 MHz) |
| `svalid_i`       | Input     | 1     | Transaction valid (frame active) |
| `frame_valid_o`  | Output    | 1     | Pulse when 27-bit frame received |
| `frame_o`        | Output    | 27    | Reconstructed frame (serial_frame_t) |
| `parity_err_o`   | Output    | 1     | Parity error detected |

**Notes**:
- Frame reception triggered by START bit (`sdata_i=1` while `svalid_i=1`)
- `sdata_i` sampled on rising edge of `sclk_i`
- 2-FF synchronizer used to detect `sclk_i` rising edge
- `frame_valid_o` asserts for 1 cycle after 27 bits received
- `parity_err_o` valid same cycle as `frame_valid_o`

---

## 3. tx_controller

**Purpose**: Master-side transaction controller with handshaking

| Port Name           | Direction | Width | Description |
|---------------------|-----------|-------|-------------|
| `clk_i`             | Input     | 1     | System clock |
| `rst_ni`            | Input     | 1     | Async active-low reset |
| `valid_i`           | Input     | 1     | Master request valid |
| `addr_i`            | Input     | 14    | Transaction address |
| `wdata_i`           | Input     | 8     | Write data |
| `we_i`              | Input     | 1     | Write enable (1=WRITE, 0=READ) |
| `ready_o`           | Output    | 1     | Ready for new transaction |
| `ser_start_o`       | Output    | 1     | Start serializer |
| `ser_frame_o`       | Output    | 27    | Frame to serialize |
| `ser_busy_i`        | Input     | 1     | Serializer busy |
| `ser_done_i`        | Input     | 1     | Serializer done |
| `trans_complete_i`  | Input     | 1     | Transaction completed |

**Handshake Protocol**:
1. Master asserts `valid_i`, provides `addr_i/wdata_i/we_i`
2. Controller asserts `ready_o=0`, latches inputs
3. Builds frame, asserts `ser_start_o`
4. Waits for `trans_complete_i`
5. Asserts `ready_o=1` for 1 cycle
6. Returns to ready when master de-asserts `valid_i`

**States**: TX_IDLE, TX_BUILD, TX_SEND, TX_WAIT

---

## 4. frame_decoder

**Purpose**: Validates and decodes serial frames to parallel control

| Port Name        | Direction | Width | Description |
|------------------|-----------|-------|-------------|
| `clk_i`          | Input     | 1     | System clock |
| `rst_ni`         | Input     | 1     | Async active-low reset |
| `frame_valid_i`  | Input     | 1     | Incoming frame valid |
| `frame_i`        | Input     | 27    | Received frame |
| `parity_err_i`   | Input     | 1     | Parity error from deserializer |
| `valid_o`        | Output    | 1     | Decoded transaction valid |
| `addr_o`         | Output    | 14    | Decoded address |
| `wdata_o`        | Output    | 8     | Decoded write data |
| `we_o`           | Output    | 1     | Write enable |
| `err_o`          | Output    | 1     | Frame error detected |

**Validation Logic**:
- `err_o=1` if: `parity_err_i=1` OR `frame_i.start!=1` OR `frame_i.stop!=1`
- `valid_o=0` if error detected
- `valid_o=1` for single cycle if frame valid

**States**: DEC_IDLE, DEC_DECODE

---

## 5. parallel_to_serial

**Purpose**: Master-side adapter bridging parallel bus to serial interface

| Port Name         | Direction | Width | Description |
|-------------------|-----------|-------|-------------|
| `clk_i`           | Input     | 1     | System clock |
| `rst_ni`          | Input     | 1     | Async active-low reset |
| **Parallel Interface (Master Side)** |
| `valid_i`         | Input     | 1     | Master request |
| `addr_i`          | Input     | 14    | Transaction address |
| `wdata_i`         | Input     | 8     | Write data |
| `we_i`            | Input     | 1     | Write enable |
| `ready_o`         | Output    | 1     | Ready for request |
| `rdata_o`         | Output    | 8     | Read response data |
| `err_o`           | Output    | 1     | Transaction error |
| **Serial Interface (Bus Side)** |
| `sdata_o`         | Output    | 1     | Serial request data |
| `sclk_o`          | Output    | 1     | Serial clock |
| `svalid_o`        | Output    | 1     | Request active |
| `sready_i`        | Input     | 1     | Slave ready |
| `sdata_i`         | Input     | 1     | Serial response data |
| `sclk_resp_i`     | Input     | 1     | Response clock |
| `svalid_resp_i`   | Input     | 1     | Response valid |

**Sub-modules**:
- `tx_controller` - Manages request handshake
- `serializer` - Transmits request frame
- `deserializer` - Receives response frame (for READs)

**Operation**:
- **WRITE**: `ready_o` asserted when `ser_done_i` pulses
- **READ**: `ready_o` asserted when response `frame_valid` pulses
- `svalid_o` tied to serializer `busy_o`

---

## 6. serial_to_parallel

**Purpose**: Slave-side adapter bridging serial interface to parallel bus

| Port Name         | Direction | Width | Description |
|-------------------|-----------|-------|-------------|
| `clk_i`           | Input     | 1     | System clock |
| `rst_ni`          | Input     | 1     | Async active-low reset |
| **Serial Interface (Bus Side)** |
| `sdata_i`         | Input     | 1     | Serial request data |
| `sclk_i`          | Input     | 1     | Serial clock |
| `svalid_i`        | Input     | 1     | Request active |
| `sready_o`        | Output    | 1     | Ready for request |
| `sdata_o`         | Output    | 1     | Serial response data |
| `sclk_resp_o`     | Output    | 1     | Response clock |
| `svalid_resp_o`   | Output    | 1     | Response active |
| **Parallel Interface (Slave Side)** |
| `valid_o`         | Output    | 1     | Transaction valid |
| `addr_o`          | Output    | 14    | Address |
| `wdata_o`         | Output    | 8     | Write data |
| `we_o`            | Output    | 1     | Write enable |
| `ready_i`         | Input     | 1     | Slave ready |
| `rdata_i`         | Input     | 8     | Read data from slave |
| `err_i`           | Input     | 1     | Slave error |

**Sub-modules**:
- `deserializer` - Receives request frame
- `frame_decoder` - Validates/decodes frame
- `serializer` - Transmits response frame (for READs)

**Response FSM States**: RESP_IDLE, RESP_WAIT_SLAVE, RESP_SENDING

**Operation**:
- WRITE: `valid_o` pulses for 1 cycle, no response sent
- READ: Waits for `ready_i`, builds response frame with `rdata_i`

---

## 7. serial_arbiter

**Purpose**: Priority arbitration with frame-atomic grants

| Port Name          | Direction | Width | Description |
|--------------------|-----------|-------|-------------|
| `clk_i`            | Input     | 1     | System clock |
| `rst_ni`           | Input     | 1     | Async active-low reset |
| `req_i`            | Input     | 2     | Master requests [1:0] |
| `gnt_o`            | Output    | 2     | Grants [1:0] (one-hot) |
| `frame_active_i`   | Input     | 1     | Frame transmission active |
| `msel_o`           | Output    | 1     | Master select (0=M0, 1=M1) |
| `split_pending_o`  | Output    | 1     | Split transaction pending |
| `split_owner_o`    | Output    | 2     | Split owner (one-hot) |

**Priority (highest to lowest)**:
1. Split transactions (`split_pending_o=1`)
2. Master 0 (`req_i[0]`)
3. Master 1 (`req_i[1]`)

**Frame-Atomic Behavior**:
- Grant held constant while `frame_active_i=1` (27-bit frame)
- New arbitration only when `frame_active_i=0` AND current requester releases

**States**: ARB_IDLE, ARB_MASTER0, ARB_MASTER1, ARB_SPLIT

---

## 8. addr_decoder

**Purpose**: Address-based routing to 3 slaves

| Port Name         | Direction | Width | Description |
|-------------------|-----------|-------|-------------|
| **Upstream Interface** |
| `valid_i`         | Input     | 1     | Transaction valid |
| `addr_i`          | Input     | 14    | Global address |
| `wdata_i`         | Input     | 8     | Write data |
| `we_i`            | Input     | 1     | Write enable |
| `ready_o`         | Output    | 1     | Slave ready (muxed) |
| `rdata_o`         | Output    | 8     | Read data (muxed) |
| `err_o`           | Output    | 1     | Error (muxed) |
| **Downstream Interface (to slaves)** |
| `slave_sel_o`     | Output    | 3     | Slave select (one-hot) |
| `slave_valid_o`   | Output    | 3     | Valid per slave |
| `slave_addr_o`    | Output    | 14    | Local address (offset) |
| `slave_wdata_o`   | Output    | 8     | Write data (broadcast) |
| `slave_we_o`      | Output    | 1     | Write enable (broadcast) |
| `slave_ready_i`   | Input     | 3     | Ready from each slave |
| `slave_rdata_i`   | Input     | 8[3]  | Read data array |
| `slave_err_i`     | Input     | 3     | Error from each slave |

**Address Decoding**:
```
addr_i[13:12] == 2'b00 → Slave 0 (0x0000-0x0FFF)
addr_i[13:12] == 2'b01 → Slave 1 (0x1000-0x1FFF)
addr_i[13:11] == 3'b100 → Slave 2 (0x2000-0x27FF)
No match → err_o=1, ready_o=1, rdata_o=0
```

**Local Address Conversion**:
- `slave_addr_o` = `addr_i - SLAVE_BASE` (offset within slave)

---

## 9. slave_mem

**Purpose**: Parameterized SRAM-based slave

**Parameters**:
- `MEM_SIZE`: Memory depth in bytes (4096 for S0/S1, 2048 for S2)

| Port Name        | Direction | Width | Description |
|------------------|-----------|-------|-------------|
| `clk_i`          | Input     | 1     | System clock |
| `rst_ni`         | Input     | 1     | Async active-low reset |
| `valid_i`        | Input     | 1     | Transaction valid |
| `addr_i`         | Input     | 14    | Local address (within slave) |
| `wdata_i`        | Input     | 8     | Write data |
| `we_i`           | Input     | 1     | Write enable |
| `ready_o`        | Output    | 1     | Operation complete |
| `rdata_o`        | Output    | 8     | Read data |
| `err_o`          | Output    | 1     | Address out of bounds |
| `split_start_i`  | Input     | 1     | Initiate split transaction |
| `split_ready_o`  | Output    | 1     | Split data ready |

**Memory Array**:
```systemverilog
logic [7:0] mem [MEM_SIZE];  // Byte-addressable memory
```

**Operation**:
- **WRITE**: `mem[addr_i] <= wdata_i`, `ready_o=1` next cycle
- **READ (normal)**: `rdata_o <= mem[addr_i]`, `ready_o=1` next cycle
- **READ (split)**: If `split_start_i=1`, delay 5 cycles before `split_ready_o=1`
- **Error**: If `addr_i >= MEM_SIZE`, `err_o=1`, `ready_o=1`

---

## 10. bitserial_top

**Purpose**: Complete system integration

| Port Name    | Direction | Width   | Description |
|--------------|-----------|---------|-------------|
| `clk_i`      | Input     | 1       | System clock (50 MHz) |
| `rst_ni`     | Input     | 1       | Async active-low reset |
| **Master Interface (Parallel)** |
| `m_req_i`    | Input     | 2       | Master requests [1:0] |
| `m_addr_i`   | Input     | 14[2]   | Addresses from M0, M1 |
| `m_wdata_i`  | Input     | 8[2]    | Write data from M0, M1 |
| `m_we_i`     | Input     | 2       | Write enables [1:0] |
| `m_gnt_o`    | Output    | 2       | Grants to M0, M1 |
| `m_ready_o`  | Output    | 2       | Ready to M0, M1 |
| `m_rdata_o`  | Output    | 8[2]    | Read data to M0, M1 |
| `m_err_o`    | Output    | 2       | Errors to M0, M1 |

**Internal Architecture**:
```
[Master 0] → [P2S_0] ┐
                      ├─→ [Arbiter] → [Serial Bus] → [S2P] → [Addr Dec] → [Slaves 0-2]
[Master 1] → [P2S_1] ┘
```

**Instantiated Modules**:
- 2× `parallel_to_serial` (master adapters)
- 1× `serial_arbiter`
- 1× `serial_to_parallel` (slave adapter)
- 1× `addr_decoder`
- 3× `slave_mem` (with sizes 4KB, 4KB, 2KB)

**Serial Bus Signals (Internal)**:
```systemverilog
logic serial_sdata;        // Muxed master request data
logic serial_sclk;         // Muxed master clock
logic serial_svalid;       // Muxed master valid
logic serial_sready;       // S2P ready signal
logic serial_resp_data;    // Response data (broadcast to all masters)
logic serial_resp_clk;     // Response clock (broadcast)
logic serial_resp_valid;   // Response valid (broadcast)
```

**Mux Logic** (driven by `master_sel` from arbiter):
```systemverilog
serial_sdata  = master_sel ? master_sdata[1]  : master_sdata[0];
serial_sclk   = master_sel ? master_sclk[1]   : master_sclk[0];
serial_svalid = master_sel ? master_svalid[1] : master_svalid[0];
```

---

## Type Definitions (bus_pkg.sv)

### serial_frame_t

Packed struct representing 27-bit serial frame:

```systemverilog
typedef struct packed {
    logic                 start;    // [26]   - START delimiter
    cmd_e                 cmd;      // [25:24] - Command
    logic [ADDR_WIDTH-1:0] addr;    // [23:10] - Address (14 bits)
    logic [DATA_WIDTH-1:0] data;    // [9:2]   - Data (8 bits)
    logic                 parity;   // [1]     - Even parity
    logic                 stop;     // [0]     - STOP delimiter
} serial_frame_t;
```

### cmd_e

Command enumeration:

```systemverilog
typedef enum logic [1:0] {
    CMD_READ           = 2'b00,
    CMD_WRITE          = 2'b01,
    CMD_SPLIT_START    = 2'b10,
    CMD_SPLIT_CONTINUE = 2'b11
} cmd_e;
```

### calc_parity

Even parity calculation function:

```systemverilog
function automatic logic calc_parity(
    input cmd_e cmd,
    input logic [ADDR_WIDTH-1:0] addr,
    input logic [DATA_WIDTH-1:0] data
);
    return ^{cmd, addr, data};  // XOR reduction (even parity)
endfunction
```

---

## Signal Naming Conventions

All modules follow lowRISC style guidelines:

- **Inputs**: `_i` suffix (e.g., `clk_i`, `valid_i`)
- **Outputs**: `_o` suffix (e.g., `ready_o`, `rdata_o`)
- **Active-low signals**: `_n` prefix (e.g., `rst_ni`)
- **Clock signals**: `clk` or `sclk` prefix
- **Reset signals**: `rst` prefix
- **Valid/ready handshake**: `valid_i/ready_o` pair
- **Data signals**: `data`, `wdata` (write), `rdata` (read)
- **Address signals**: `addr`
- **Error signals**: `err`
- **Arrays**: Suffix with array index (e.g., `m_addr_i[NUM_MASTERS]`)

---

## Timing Requirements

**Setup/Hold Times**:
- All signals sampled on rising edge of `clk_i`
- Async reset `rst_ni` (active-low)

**Serial Interface**:
- `sdata_o` stable on rising edge of `sclk_o`
- `sdata_i` sampled on rising edge of `sclk_i`
- SCLK period: 80 ns (12.5 MHz)
- SCLK generated with 50% duty cycle

**Handshake Protocol**:
- Valid-ready handshake: 4-phase (valid→ready→valid low→ready low)
- Grant-atomic: `gnt_o` held constant during `frame_active_i`
